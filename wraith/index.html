<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wraith Wheels ‚Äî The Night Watcher</title>
      <link rel="stylesheet" href="styles.css?v=11">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
</head>
<body>
  <!-- Animated background elements -->
  <div class="bg-animation">
    <div class="floating-ghost ghost-1">üëª</div>
    <div class="floating-ghost ghost-2">ü¶á</div>
    <div class="floating-ghost ghost-3">üëª</div>
    <div class="fog"></div>
  </div>

  <header>
    <div class="moon">üåï</div>
    <h1 class="spooky-title">
      <span class="icon-float">üéÉ</span>
      WRAITH WHEELS
      <span class="icon-float">ü¶á</span>
    </h1>
    <p class="subtitle glitch" data-text="The Night Watcher">The Night Watcher</p>
    <p class="tagline">Stay awake... or face the pumpkin's curse üíÄ</p>
  </header>

  <main>
    <div class="container">
      <!-- Sidebar Controls -->
      <aside class="sidebar">
        <div class="control-section">
          <div class="action-buttons">
            <button id="startBtn" class="btn-primary">
              <span class="btn-icon">üïØÔ∏è</span>
              AWAKEN
            </button>
            <button id="stopBtn" class="btn-secondary" disabled>
              <span class="btn-icon">‚ö∞Ô∏è</span>
              REST
            </button>
          </div>
        </div>

        <!-- Basic Settings -->
        <details class="accordion" open>
          <summary class="accordion-header">
            <span class="accordion-icon">üëÅÔ∏è</span>
            <span>Basic Detection</span>
          </summary>
          <div class="accordion-content">
            <div class="control">
              <label for="threshold">Eye Threshold <span id="thresholdVal" class="value-badge">0.24</span></label>
              <input type="range" id="threshold" min="0.12" max="0.35" step="0.01" value="0.24" />
            </div>
            <div class="control">
              <label for="duration">Closed Duration (sec) <span id="durationVal" class="value-badge">1.5</span></label>
              <input type="range" id="duration" min="0.5" max="3.0" step="0.1" value="1.5" />
            </div>
            <div class="control">
              <label for="hideDelay">Pumpkin Hide Delay (sec) <span id="hideDelayVal" class="value-badge">0.40</span></label>
              <input type="range" id="hideDelay" min="0.0" max="2.0" step="0.05" value="0.40" />
            </div>
          </div>
        </details>

        <!-- CNN Settings -->
        <details class="accordion">
          <summary class="accordion-header">
            <span class="accordion-icon">üß†</span>
            <span>AI Vision (CNN)</span>
          </summary>
          <div class="accordion-content">
            <div class="control checkbox-control">
              <label class="switch">
                <input type="checkbox" id="useCnn" />
                <span class="slider"></span>
              </label>
              <span>Enable CNN Eye Classifier</span>
            </div>
            <div class="control">
              <label for="cnnThresh">CNN Closed Prob <span id="cnnThreshVal" class="value-badge">0.60</span></label>
              <input type="range" id="cnnThresh" min="0.30" max="0.90" step="0.01" value="0.60" />
            </div>
            <div class="control">
              <label for="cnnPumpkinDelay">CNN Pumpkin Delay (sec) <span id="cnnPumpkinDelayVal" class="value-badge">2.0</span></label>
              <input type="range" id="cnnPumpkinDelay" min="0.0" max="5.0" step="0.1" value="2.0" />
            </div>
            <div class="control checkbox-control">
              <label class="switch">
                <input type="checkbox" id="useMouthCnn" />
                <span class="slider"></span>
              </label>
              <span>Enable Mouth Classifier</span>
            </div>
          </div>
        </details>

        <!-- Head Tilt Settings -->
        <details class="accordion">
          <summary class="accordion-header">
            <span class="accordion-icon">üîÑ</span>
            <span>Head Tilt Detection</span>
          </summary>
          <div class="accordion-content">
            <div class="control">
              <label for="tiltThresh">Tilt Threshold (deg) <span id="tiltThreshVal" class="value-badge">12</span></label>
              <input type="range" id="tiltThresh" min="5" max="30" step="1" value="12" />
            </div>
            <div class="control">
              <label for="tiltCooldown">Tilt Cooldown (sec) <span id="tiltCooldownVal" class="value-badge">2.5</span></label>
              <input type="range" id="tiltCooldown" min="0.5" max="5.0" step="0.1" value="2.5" />
            </div>
          </div>
        </details>

        <!-- Yawn Detection -->
        <details class="accordion">
          <summary class="accordion-header">
            <span class="accordion-icon">ü•±</span>
            <span>Yawn Detection</span>
          </summary>
          <div class="accordion-content">
            <div class="control">
              <label for="yawnThresh">Yawn Probability <span id="yawnThreshVal" class="value-badge">0.60</span></label>
              <input type="range" id="yawnThresh" min="0.25" max="0.95" step="0.01" value="0.60" />
            </div>
            <div class="control">
              <label for="yawnCooldown">Yawn Cooldown (sec) <span id="yawnCooldownVal" class="value-badge">3.0</span></label>
              <input type="range" id="yawnCooldown" min="1.0" max="10.0" step="0.5" value="3.0" />
            </div>
            <div class="control">
              <label for="yawnMorMin">Min Mouth Opening <span id="yawnMorMinVal" class="value-badge">0.35</span></label>
              <input type="range" id="yawnMorMin" min="0.20" max="0.70" step="0.01" value="0.35" />
            </div>
            <div class="control">
              <label for="yawnMinDur">Min Duration (sec) <span id="yawnMinDurVal" class="value-badge">0.5</span></label>
              <input type="range" id="yawnMinDur" min="0.1" max="2.0" step="0.1" value="0.5" />
            </div>
          </div>
        </details>

        <!-- Debug Mode -->
        <details class="accordion">
          <summary class="accordion-header">
            <span class="accordion-icon">üï∑Ô∏è</span>
            <span>Debug / Capture</span>
          </summary>
          <div class="accordion-content">
            <div class="control checkbox-control">
              <label class="switch">
                <input type="checkbox" id="captureMode" />
                <span class="slider"></span>
              </label>
              <span>Dataset Capture Mode</span>
            </div>
            <p class="hint">Press n/o/s/y keys to save crops</p>
          </div>
        </details>
      </aside>

      <!-- Main Content -->
      <section class="main-content">
      <div class="control">
        <label for="hideDelay">Pumpkin hide delay (sec) <span id="hideDelayVal">0.40</span></label>
        <input type="range" id="hideDelay" min="0.0" max="2.0" step="0.05" value="0.40" />
      </div>
      <div class="control">
        <label for="tiltThresh">Tilt threshold (deg) <span id="tiltThreshVal">12</span></label>
        <input type="range" id="tiltThresh" min="5" max="30" step="1" value="12" />
      </div>
      <div class="control">
        <label for="tiltCooldown">Tilt cooldown (sec) <span id="tiltCooldownVal">2.5</span></label>
        <input type="range" id="tiltCooldown" min="0.5" max="5.0" step="0.1" value="2.5" />
      </div>
      <div class="control">
        <label>
          <input type="checkbox" id="useGaze" />
          Detect gaze drift (experimental)
        </label>
      </div>
      <div class="control">
        <label for="gazeThreshold">Gaze drift threshold <span id="gazeThresholdVal">0.45</span></label>
        <input type="range" id="gazeThreshold" min="0.20" max="0.80" step="0.01" value="0.45" />
      </div>
      <div class="control">
        <label for="gazeHold">Gaze hold (sec) <span id="gazeHoldVal">1.2</span></label>
        <input type="range" id="gazeHold" min="0.5" max="3.0" step="0.1" value="1.2" />
      </div>
      <div class="control">
        <label>
          <input type="checkbox" id="gazeCalibEnable" />
          Use calibration (center)
        </label>
      </div>
      <div class="control">
        <button id="gazeCalibrateBtn">Calibrate center (1s)</button>
      </div>
      <div class="control">
        <label for="gazeSigmaK">Calibration sigma √ó <span id="gazeSigmaKVal">2.0</span></label>
        <input type="range" id="gazeSigmaK" min="1.0" max="4.0" step="0.1" value="2.0" />
      </div>
      <div class="control">
        <label for="gazeSmoothWin">Gaze smoothing window <span id="gazeSmoothWinVal">5</span></label>
        <input type="range" id="gazeSmoothWin" min="3" max="15" step="1" value="5" />
      </div>
      <div class="control">
        <label for="yawnThresh">Yawn prob threshold <span id="yawnThreshVal">0.60</span></label>
        <input type="range" id="yawnThresh" min="0.25" max="0.95" step="0.01" value="0.60" />
      </div>
      <div class="control">
        <label for="yawnCooldown">Yawn cooldown (sec) <span id="yawnCooldownVal">3.0</span></label>
        <input type="range" id="yawnCooldown" min="1.0" max="10.0" step="0.5" value="3.0" />
      </div>
      <div class="control">
        <label for="yawnMorMin">Yawn min mouth-open (MOR) <span id="yawnMorMinVal">0.35</span></label>
        <input type="range" id="yawnMorMin" min="0.20" max="0.70" step="0.01" value="0.35" />
      </div>
      <div class="control">
        <label for="yawnMinDur">Yawn min duration (sec) <span id="yawnMinDurVal">0.5</span></label>
        <input type="range" id="yawnMinDur" min="0.1" max="2.0" step="0.1" value="0.5" />
      </div>

      <hr />
      <h3>Predictive drowsiness alert (10‚Äì20 min)</h3>
      <div class="control">
        <label>
          <input type="checkbox" id="usePredict" />
          Enable predictive alert
        </label>
      </div>
      <div class="control">
        <label for="predictThresh">Alert threshold <span id="predictThreshVal">0.65</span></label>
        <input type="range" id="predictThresh" min="0.50" max="0.95" step="0.01" value="0.65" />
      </div>
      <div class="control">
        <label for="predictWindow">Feature window (sec) <span id="predictWindowVal">120</span></label>
        <input type="range" id="predictWindow" min="60" max="300" step="10" value="120" />
      </div>
      <div class="control">
        <label>Predicted drowsiness (next ~15m): <span id="predictProb">-</span></label>
      </div>

      <hr />
      <h3>Sleep profile (adaptive thresholds)</h3>
      <div class="control">
        <label>
          <input type="checkbox" id="autoAdapt" />
          Auto-adapt thresholds by sleep profile
        </label>
      </div>
      <div class="control">
        <label for="idealSleep">Ideal sleep (hrs) <span id="idealSleepVal">7.5</span></label>
        <input type="range" id="idealSleep" min="5.0" max="9.0" step="0.5" value="7.5" />
      </div>
      <div class="control">
        <label for="lastSleepHours">Last sleep duration (hrs)</label>
        <input type="number" id="lastSleepHours" min="0" max="14" step="0.25" placeholder="e.g., 6.5" />
      </div>
      <div class="control">
        <label for="sleepImport">Import sleep JSON</label>
        <input type="file" id="sleepImport" accept="application/json" />
      </div>
      <div class="control">
        <button id="connectGoogleFit" disabled title="Provide OAuth client ID in config to enable">Connect Google Fit (coming soon)</button>
      </div>
      <div class="control">
        <label>Sleep risk factor: <span id="sleepRisk">-</span></label>
        <button id="resetAdapt">Reset adaptations</button>
      </div>

      <hr />
      <h3>üéÆ Safety Microgame</h3>
      <div class="control">
        <label>Movement: <span id="moveStatus">Unknown</span></label>
      </div>
      <div class="control">
        <label>Drowsiness Score: <span id="drowsyScore">0</span> / 3</label>
      </div>
      <div class="control">
        <label>
          <input type="checkbox" id="manualStopToggle" />
          Manual "Stopped" Override (for testing)
        </label>
      </div>
      <div class="control">
        <small style="color: #888;">System will alert if drowsy while moving, then launch microgame when stopped.</small>
      </div>

      <hr />
      <div class="control">
        <label>
          <input type="checkbox" id="captureMode" />
          Dataset capture mode (press n/o/s/y to save crop)
        </label>
      </div>
      <div class="control">
        <label for="yawnMorMin">Yawn min mouth-open (MOR) <span id="yawnMorMinVal">0.35</span></label>
        <input type="range" id="yawnMorMin" min="0.20" max="0.70" step="0.01" value="0.35" />
      </div>
      <div class="control">
        <label for="yawnMinDur">Yawn min duration (sec) <span id="yawnMinDurVal">0.5</span></label>
        <input type="range" id="yawnMinDur" min="0.1" max="2.0" step="0.1" value="0.5" />
      </div>
    </section>

    <section class="video-stage">
      <div class="videoWrap">
        <video id="video" playsinline></video>
        <canvas id="output"></canvas>
      </div>
      <div class="status">
        <div>State: <span id="state">idle</span></div>
        <div>Target face: <span id="targetFace">-</span></div>
        <div>EAR L/R: <span id="earL">-</span> / <span id="earR">-</span></div>
  <div>CNN prob L/R: <span id="cnnL">-</span> / <span id="cnnR">-</span></div>
  <div>Mouth: <span id="mouthPred">-</span></div>
    <div>Gaze x/y: <span id="gazeX">-</span> / <span id="gazeY">-</span> ¬∑ Drift: <span id="gazeDrift">off</span></div>
  <div>Drift hold: <span id="gazeHoldProg">0.0</span>/<span id="gazeHoldTarget">1.2</span>s</div>
        <div>Closed for: <span id="closedTime">0.0s</span></div>
  <div>Drowsy count: <span id="drowsyCount">0</span></div>
        <div id="msg"></div>
        <div class="hint">Capture mode: Press n/o/s/y to save neutral/open/smile/yawn crop as PNG.</div>
        <div class="hint">Tip: Click a box or use ‚Üê/‚Üí to choose the target face.</div>
      </div>
    </section>
  </main>

  <footer>
    <small>Camera stays on-device. Built with MediaPipe Face Mesh in the browser.</small>
  </footer>

  <!-- MediaPipe libs (no build needed) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <!-- TensorFlow.js for CNN eye classifier -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>

  <script src="app.js"></script>
</body>
</html>
